<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.32.2" />
  <meta name="author" content="John R. Lewis">
  <meta name="description" content="Senior Member of Technical Staff">

  
  <link rel="alternate" hreflang="en-us" href="/post/storing-and-plotting-functional-data-using-tibble/">

  
  


  

  
  
  
  
    
  
  
    
    
      
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
      
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.1/css/academicons.min.css" integrity="sha512-NThgw3XKQ1absAahW6to7Ey42uycrVvfNfyjqcFNgCmOCQ5AR4AO0SiXrN+8ZtYeappp56lk1WtvjVmEa+VR6A==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7cMerriweather%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-111591330-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="John R. Lewis">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="John R. Lewis">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/post/storing-and-plotting-functional-data-using-tibble/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@_jrlewi">
  <meta property="twitter:creator" content="@_jrlewi">
  
  <meta property="og:site_name" content="John R. Lewis">
  <meta property="og:url" content="/post/storing-and-plotting-functional-data-using-tibble/">
  <meta property="og:title" content="Storing and Plotting Functional Data using Tibble | John R. Lewis">
  <meta property="og:description" content="">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2017-05-28T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2017-05-28T00:00:00&#43;00:00">
  

  

  <title>Storing and Plotting Functional Data using Tibble | John R. Lewis</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/">John R. Lewis</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        

        
          
        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#publications">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#talks">
            
            <span>Talks</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/pdf/cv.pdf">
            
            <span>CV</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <div class="article-inner">
      <h1 itemprop="name">Storing and Plotting Functional Data using Tibble</h1>

      

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2017-05-28 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      May 28, 2017
    </time>
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  
  <span class="middot-divider"></span>
  <a href="/post/storing-and-plotting-functional-data-using-tibble/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="/categories/r">R</a
    >, 
    
    <a href="/categories/tidyverse">tidyverse</a
    >, 
    
    <a href="/categories/functional-data">functional data</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Storing%20and%20Plotting%20Functional%20Data%20using%20Tibble&amp;url=%2fpost%2fstoring-and-plotting-functional-data-using-tibble%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fpost%2fstoring-and-plotting-functional-data-using-tibble%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fpost%2fstoring-and-plotting-functional-data-using-tibble%2f&amp;title=Storing%20and%20Plotting%20Functional%20Data%20using%20Tibble"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fpost%2fstoring-and-plotting-functional-data-using-tibble%2f&amp;title=Storing%20and%20Plotting%20Functional%20Data%20using%20Tibble"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Storing%20and%20Plotting%20Functional%20Data%20using%20Tibble&amp;body=%2fpost%2fstoring-and-plotting-functional-data-using-tibble%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


      <div class="article-style" itemprop="articleBody">
        <p>The <a href="https://cran.r-project.org/web/packages/tibble/vignettes/tibble.html">tibble package</a> within the <a href="http://tidyverse.org/">the tidyverse</a> provides ‘a modern take on data frames.’ It’s loaded with nice features, one of which is the ability to store list-columns. List-columns provide a concise way to store lists within a row of a data frame. In particular, this is useful for storing functional data because a common feature in such data is that each function is not collected at the same number of points. As an example, let’s simulate some sinusoids:</p>
<pre class="r"><code>library(tidyverse)
## Loading tidyverse: ggplot2
## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr
## Conflicts with tidy packages ----------------------------------------------
## filter(): dplyr, stats
## lag():    dplyr, stats
set.seed(123)
n &lt;- 5
factor_1 &lt;- c(rep(&#39;A&#39;, n), rep(&#39;B&#39;, n))

response &lt;- function(x,mu, A, B, C){
  mu + A*sin(x*B + C)
}

out &lt;- sapply(factor_1, function(y){
n_pts &lt;- floor(rnorm(1, 100, 10))
x &lt;- seq(-pi/2, pi/2, length.out = n_pts)
mu &lt;- ifelse(y == &#39;A&#39;,2,1)
mu &lt;- rnorm(1, mu, .1)
A &lt;- rnorm(1, 2, sd = .3)
B &lt;- rnorm(1, 3, sd = .3)
C &lt;- rnorm(1, pi/8, sd = .1)
list(x = x, output = response(x,mu,A,B,C))
})</code></pre>
<p>There are 5 curves in each level of the factor factor_1 (A or B). The average difference in the two levels is a vertical mean shift and each function has some amplitude and horizontal variation. Each function has around 100 points but this varies. Tibble’s framework allows us to store this type of data concisely using list-columns:</p>
<pre class="r"><code>tbl &lt;- tibble(test = 1:length(factor_1),factor_1 = factor_1, x =  out[1,], y = out[2,])
tbl</code></pre>
<pre><code>## # A tibble: 10 x 4
##     test factor_1           x           y
##    &lt;int&gt;    &lt;chr&gt;      &lt;list&gt;      &lt;list&gt;
##  1     1        A  &lt;dbl [94]&gt;  &lt;dbl [94]&gt;
##  2     2        A &lt;dbl [117]&gt; &lt;dbl [117]&gt;
##  3     3        A &lt;dbl [112]&gt; &lt;dbl [112]&gt;
##  4     4        A &lt;dbl [117]&gt; &lt;dbl [117]&gt;
##  5     5        A  &lt;dbl [89]&gt;  &lt;dbl [89]&gt;
##  6     6        B  &lt;dbl [83]&gt;  &lt;dbl [83]&gt;
##  7     7        B &lt;dbl [104]&gt; &lt;dbl [104]&gt;
##  8     8        B &lt;dbl [106]&gt; &lt;dbl [106]&gt;
##  9     9        B  &lt;dbl [93]&gt;  &lt;dbl [93]&gt;
## 10    10        B  &lt;dbl [88]&gt;  &lt;dbl [88]&gt;</code></pre>
<p>Plotting the data with base R can be done easily enough:</p>
<pre class="r"><code>yrange &lt;- range(sapply(tbl$y, function(y) range(y)))
plot(NULL, type = &#39;l&#39;, col = 1, ylim = yrange, xlim = c(-pi/2,pi/2), ylab = &#39;y&#39;, xlab = &#39;x&#39;)
for(i in 1:nrow(tbl)){
  matplot(tbl$x[[i]], tbl$y[[i]], type = &#39;l&#39;, col = ifelse(tbl$factor_1[i] == &#39;A&#39;,1,2), add = TRUE)
}
grid()
legend(&#39;topright&#39;, col = c(1,2), lty = 1, legend = c(&#39;A&#39;,&#39;B&#39;), title = &#39;factor_1&#39;)</code></pre>
<p><img src="/post/2017-05-28-storing-and-plotting-functional-data-using-tibble_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>While this is satisfactory, users of <code>ggplot2</code> understand some of its <a href="https://github.com/tidyverse/ggplot2/wiki/Why-use-ggplot2">advantages over base graphics</a>. When first thinking about plotting with <code>ggplot2</code>, I was hoping this would work:</p>
<pre class="r"><code>gplot &lt;- ggplot(tbl, aes(x = x,y = y, group = test, colour = factor_1)) + 
  geom_line()</code></pre>
<p>Unfortunately, this throws an error since the functions have different lengths. A work-around is to expand the tibble to fit the so-called <a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">tidy format</a> with each observation on each function corresponding to a single row. Originally I was using <code>do.call()</code> to do this. Then I happily discovered <code>tidyr::unnest</code> (and its inverse <code>tidyr::nest</code>):</p>
<pre class="r"><code># tbl2 &lt;- do.call(rbind,apply(tbl,1, function(r) tibble(test = r$test, factor_1 = r$factor_1, x = r$x, y = r$y)))
# tbl2

(tbl2 &lt;- unnest(tbl))</code></pre>
<pre><code>## # A tibble: 1,003 x 4
##     test factor_1         x        y
##    &lt;int&gt;    &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1     1        A -1.570796 4.275455
##  2     1        A -1.537016 4.172024
##  3     1        A -1.503235 4.045749
##  4     1        A -1.469455 3.897947
##  5     1        A -1.435674 3.730154
##  6     1        A -1.401893 3.544116
##  7     1        A -1.368113 3.341771
##  8     1        A -1.334332 3.125223
##  9     1        A -1.300552 2.896725
## 10     1        A -1.266771 2.658657
## # ... with 993 more rows</code></pre>
<pre class="r"><code># Note: tbl2 %&gt;% group_by(test, factor_1) %&gt;% nest() or simply nest(tbl2, x,y) gets you back to tbl (almost...do you see what&#39;s different?)
(gplot &lt;- ggplot(tbl2, aes(x = x,y = y, group = test, colour = factor_1)) + 
    geom_line())</code></pre>
<p><img src="/post/2017-05-28-storing-and-plotting-functional-data-using-tibble_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>This works well. One departing thought – In many cases functional data is collected at ~1e6 or more points and expanding the table as above could easily result in tens of millions of rows - with a bunch of redundant information in the first two columns ‘test’ and ‘factor_1.’ My guess is this really isn’t that big of an issue…but if you think it is, please let me know.</p>

      </div>

      


<div class="article-tags">
  
  <a class="btn btn-primary btn-outline" href="/tags/r">R</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/tidyverse">tidyverse</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/functional-data">functional data</a>
  
</div>



    </div>
  </div>

</article>



<div class="article-container article-widget">
  <div class="hr-light"></div>
  <h3>Related</h3>
  <ul>
    
    <li><a href="/post/a-quick-intro-to-robust-bayesian-models-via-conditioning-on-insufficient-statistics/">A Quick Intro to Robust Bayesian Models via Conditioning on Insufficient Statistics</a></li>
    
  </ul>
</div>




<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jrlewi-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 John R. Lewis &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    
    <script id="dsq-count-scr" src="//jrlewi-github-io.disqus.com/count.js" async></script>
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
      

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" integrity="sha512-tOav5w1OjvsSJzePRtt2uQPFwBoHt1VZcUq8l8nm5284LEKE9FSJBQryzMBzHxY5P0zRdNqEcpLIRVYFNgu1jw==" crossorigin="anonymous"></script>
    
    

  </body>
</html>

